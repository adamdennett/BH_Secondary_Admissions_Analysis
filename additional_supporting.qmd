---
title: "Week 2 of the engagement ('it's not a consultation!') exercise"
author: "Adam Dennett"
---


```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(plotly)
library(tmap)
library(here)
library(ggplot2)
library(janitor)
library(sf)

```

```{r, echo=F, message=F, warning=F}

admissions <- read_csv(here("data", "Yr7_admissions.csv")) %>% clean_names()

admissions_long <- admissions %>% 
  select(school:total_app_count) %>%
  pivot_longer(pan:total_app_count, names_to = "stat_type", values_to = "stat")

```

```{r, echo=F, message=F, warning=F}
brighton_sec_schools <- read_csv("https://www.dropbox.com/scl/fi/fhzafgt27v30lmmuo084y/edubasealldata20241003.csv?rlkey=uorw43s44hnw5k9js3z0ksuuq&raw=1") %>% 
  clean_names() %>% 
  filter(la_name == "Brighton and Hove") %>% 
  filter(phase_of_education_name == "Secondary") %>% 
  filter(establishment_status_name == "Open") %>%
  st_as_sf(., coords = c("easting", "northing")) %>% 
  st_set_crs(27700)

edubase_sec_schools <- read_csv("https://www.dropbox.com/scl/fi/fhzafgt27v30lmmuo084y/edubasealldata20241003.csv?rlkey=uorw43s44hnw5k9js3z0ksuuq&raw=1") %>% 
  clean_names()

variable_list <- as.data.frame(names(edubase_sec_schools))

```

On this page I will include some additional supporting data visualisations.

Firstly some visualisation of the allocation of Year 7 places across the city

Data taken from here - <https://www.brighton-hove.gov.uk/allocation-factsheet-year-7-places-september-2024>

**Not much to see here yet, but I will get there with some more interesting bits** - including some spatial interaction / gravity modelling to show how much heavy-lifting the present catchments may already be doing on the equity side of things - hope to get to it by the end of the week.

### Terminology and Background

PAN - Published Admission Number. This is the number of pupils a school is permitted to allow to enter a school in Year 7.

FSM - Free School Meals. This is the proportion of pupils in a school or residential area that receive free school meals because their household income is below a certain threshold. It is a widely used measure of social deprivation.

## The PAN Problems

It has become clearer to me over the last week that one of the big issues in this whole consultation process is the PAN - both the total PAN in different years, which relates to population projections produced by the Council, and the individual school-level PANs which affect how many pupils a school can admit at year 7. I will take each in turn, but first some local background.

In most secondary schools in Brighton (Stringer, Varndean, Hove Park, Blatchington, Patcham, Longhill) the PAN is set by the council.

Religious and Free Schools such as Cardinal Newman and King's School are allowed to set their own PANs.

Academies (Brighton Aldridge Community Academy - BACA, and Portslade Aldridge Community Academy - PACA) are also allowed to set their own PANs.

One issue is that PANs for all schools contribute to the overall total number of places in the City. So if the Council is determined to reduce the number of places (PANs) in the city, if the Religious Schools and the Academies refuse to reduce their PANs and the council is wedded to reducing numbers, the only way it can do this is by cutting, proportionally, MORE places from Stringer, Varndean, Hove Park, Blatchington, Patcham, Longhill than it would have done if it could control PANs in all state funded schools in the City.

In the [People Overview and Scrutiny Committee held on 9/10/2024](https://democracy.brighton-hove.gov.uk/ieListDocuments.aspx?CId=1129&MId=11719&Ver=4), Councillor (Haver\* NB check name, this is what it sounded like live) raised a point that a Government White Paper is on the horizon which may give local authorities the power to control ALL PANs in the near future - this could alleviate some of the issues I am about to describe, but at the moment, nothing can be done.

## PANS across Brighton

The graph below shows the PANs for 2024 taken from here:

<https://www.brighton-hove.gov.uk/allocation-factsheet-year-7-places-september-2024>

```{r, echo=F, message=F, warning=F}

library(ggplot2)

filtered_admissions <- admissions_long %>%
  filter(stat_type == "pan")

average_stat <- mean(filtered_admissions$stat, na.rm = TRUE)

ggplot(filtered_admissions, aes(x = reorder(school, -as.numeric(factor(school))), y = stat)) +
  geom_bar(aes(fill = type), stat = "identity", position = "dodge2") +
  xlab("") +
  ylab("PAN 2024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip() +
  geom_hline(yintercept = average_stat, linetype = "dotted", color = "red") +
  annotate("text", x = Inf, y = average_stat, label = c("Average", average_stat), vjust = -0.5, hjust = 2.1, angle = 90, color = "red") +
  scale_fill_discrete(name = "School Type")
```

We can see from this graph that the academy schools and King's School have a relatively low PAN compared to other schools in the City, with Cardinal Newman enjoying a PAN well above average at 360. This represents 14% of the total places available.

As an interesting aside, we know from the 2021 Census that 30.9% of the population of Brighton identify as Christian - <https://www.ons.gov.uk/census/maps/choropleth/identity/religion/religion-tb/christian?lad=E06000043> - if we believe wikipedia - <https://en.wikipedia.org/wiki/Religion_in_the_United_Kingdom> - 13% of Christians in the UK are Catholic. So if we apply that percentage to Brighton, we can expect 3.9% of the population to be Roman Catholic. But 14% of the school places can be reserved for Catholic Children as a priority. I'll just leave that there to sink in!

## PANS vs Applications and Intake

The graph below includes exactly the same numbers as above, but this time contextualises them relative to the total number of applications each school had in 2024 and the number of places that were actually offered to students that year. 

```{r}
filtered_admissions <- admissions_long %>%
  filter(stat_type %in% c("pan", "total_offer_count", "total_app_count"))

ggplot(filtered_admissions, aes(x = reorder(school, -as.numeric(factor(school))), y = stat)) +
  geom_bar(aes(fill = stat_type), stat = "identity", position = "dodge2") +
  xlab("") +
  ylab("Count 2024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("pan" = "#1f77b4", "total_offer_count" = "#ff7f0e", "total_app_count" = "#2ca02c"),
                    labels = c("pan" = "PAN", "total_offer_count" = "Total Offer Count", "total_app_count" = "Total Application Count"))

```


A couple of things to point out:

1. Total Applications include all 1st, 2nd and 3rd choices for each school. It's likely that schools in multi-school catchments may receive both first and second choices, potentially artificially inflating that number relative to the schools in single school catchments, so bear that in mind, however it can still be viewed as a crude measure of demand. I will disaggregate 1st, 2nd, and 3rd choices in some other graphs below. 

2. All schools within multi-school catchments are very popular and are able to easily fill their offer numbers and probably could at least twice over - which is useful context when considering PAN reductions. 

3. Some schools in Brighton received low numbers of applications. For BACA and Longhill, the numbers of applications they received were BELOW their PANs. These were not popular schools in 2024. 

4. For BACA and Longhill, their total offer numbers were also below their PANs. This means the schools were very under-subscribed and had excess capacity.  

## First Preferences, Offers and Ratios

```{r}
filtered_admissions <- admissions_long %>%
  filter(stat_type %in% c("pan", "first_pref_count", "first_pref_offer_count", "first_pref_reject_count"))

ggplot(filtered_admissions, aes(x = reorder(school, -as.numeric(factor(school))), y = stat)) +
  geom_bar(aes(fill = stat_type), stat = "identity", position = "dodge2") +
  xlab("") +
  ylab("Count 2024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip() +
  scale_fill_manual(values = c("pan" = "#b3cde0", "first_pref_count" = "#decbe4", "first_pref_offer_count" = "#fed9a6", "first_pref_reject_count" = "#ffffcc"),
                    labels = c("pan" = "PAN", "first_pref_count" = "First Preferences", "first_pref_offer_count" = "First Preference Offers", "first_pref_reject_count" = "First Preference Rejections"))

```



## Small Schools in England and Wales

The histogram below shows the distribution of the number of pupils in open, state funded 11-16 secondary schools in England and Wales. The red and cyan lines show the number of pupils at Longhill and PACA respectively.

I have not included BACA in this graph as it is an 11-19 school and thus not directly comparable, however the recorded number on its role in 2024 is 802 - so a much smaller school than Longhill.

```{r, echo=F, message=F, warning=F}
edubase_sec_schools %>% 
  filter(phase_of_education_name == "Secondary") %>% 
  filter(establishment_status_name == "Open") %>%
  filter(statutory_high_age == 16) %>%
ggplot(., aes(x = number_of_pupils)) +
  geom_histogram(binwidth = 30) +
  labs(x = "Total Number of Pupils in the School", y = "Number of Schools in England and Wales") +
  geom_vline(xintercept = 825, linetype = "dotted", color = "red") +
  annotate("text", x = 825, y = Inf, label = "Longhill", vjust = 16.5, color = "red") + 
  geom_vline(xintercept = 974, linetype = "dotted", color = "cyan") +
  annotate("text", x = 974, y = Inf, label = "PACA", vjust = 18.5, color = "cyan") +
  theme_minimal()

```

## Closing Schools in Brighton and Hove with low numbers

The council has repeated cited at the in person consultation meeting I attended and again in the [People Overview and Scrutiny Committee held on 9/10/2024](https://democracy.brighton-hove.gov.uk/ieListDocuments.aspx?CId=1129&MId=11719&Ver=4) that it is not sustainable to have schools with low numbers of pupils. In the Scrutiny meeting, Councillor Haver asked a question about the minimum viability of schools.

Councillor Collier and Colleague commented that is was their view that 180 pupils was the *minimum* single year PAN they would consider viable.

```{r}

brighton_sec_schools %>% 
  ggplot(., aes(x = number_of_pupils, y = establishment_name)) +
  geom_bar(stat = "identity") +
  theme_minimal()

```

```{r, echo=F, message=F, warning=F}

library(ggplot2)

filtered_admissions <- admissions_long %>%
  filter(stat_type == "pan")

average_stat <- mean(filtered_admissions$stat, na.rm = TRUE)

ggplot(filtered_admissions, aes(x = reorder(school, -as.numeric(factor(school))), y = stat)) +
  geom_bar(aes(fill = type), stat = "identity", position = "dodge2") +
  xlab("") +
  ylab("PAN 2024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip() +
  geom_hline(yintercept = average_stat, linetype = "dotted", color = "red") +
  annotate("text", x = Inf, y = average_stat, label = "Average", vjust = -0.5, hjust = 1.1, angle = 90, color = "red") +
  scale_fill_discrete(name = "School Type")


```

```{r, echo=F, message=F, warning=F}
ggplot(admissions_long, aes(x = reorder(school, -as.numeric(factor(school))), y = stat)) +
  geom_bar(aes(fill = stat_type), stat = "identity", position = "dodge2") +
  xlab("School") +
  ylab("Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()
```

```{r}

#get some LSOA pop weighted centroids for E&W from ONS
url <- "https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/LLSOA_Dec_2021_PWC_for_England_and_Wales_2022/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"

# Read the GeoJSON file into an sf object
sf_point_data <- st_read(url)
#save locally
st_write(sf_point_data, here("data", "EW_LSOA_PW_Centoid.geojson"), append = TRUE)

#brighton school data
brighton_school_children <- read_csv(here("data", "BrightonLSOASchoolChildren.csv"))

btn_lsoa_list <- as.data.frame(brighton_school_children$lsoa_code) %>% 
  clean_names()

lsoa_btn_pw_centroids <- sf_point_data %>% 
  st_transform(27700) %>% 
  clean_names %>% 
  select(lsoa21cd, geometry)

lsoa_btn_pw_centroids <- lsoa_btn_pw_centroids %>% right_join(btn_lsoa_list, by = c("lsoa21cd" = "brighton_school_children_lsoa_code"))

st_write(lsoa_btn_pw_centroids, here("data", "lsoa_btn_pw_centroids.geojson"), append = TRUE)
```

```{r, echo=F, message=F, warning=F}

#catchments
bh_catchments <- st_read(here("data","BrightonSecondaryCatchments.geojson"))

#lsoa data
sf_data <- st_read(here("data","EW_LSOA.geojson"))
sf_data <- clean_names(sf_data)

#lsoa data
brighton_lsoa <- sf_data %>% right_join(brighton_school_children, by = c("lsoa21cd" = "lsoa_code"))

#lsoa centroids
brighton_lsoa_centroids <- st_centroid(brighton_lsoa) %>% 
  st_transform(27700)

brighton_lsoa_centroids_simple <- st_centroid(brighton_lsoa) %>% 
  st_transform(27700) %>% 
  select(lsoa21cd, geometry)

brighton_oa <- st_read(here("data","oa_brighton.geojson"))

brighton_roads <- st_read(here("data","brighton_roads.shp"))

#Fix the school and school data so r5 can handle it
#schools first

brighton_sec_schools_wgs84 <- brighton_sec_schools %>%
  st_transform(4326) %>% 
  st_set_crs(4326)

bh_sec_sch <- brighton_sec_schools_wgs84 %>% 
  select(urn, establishment_name, geometry) %>%
  rename(id = urn)

coords <- st_coordinates(bh_sec_sch)
bh_sec_sch$lon <- coords[, 1]
bh_sec_sch$lat <- coords[, 2]

bh_sec_sch_bng <- bh_sec_sch %>% 
  st_transform(27700)

#now the LSOAs
brighton_lsoa_points_r5 <- brighton_lsoa_centroids %>% 
  select(fid, lsoa21cd,lat, long) %>% 
  rename(lon = long, lat = lat, id = fid) %>% 
  st_transform(4326) %>% 
  st_set_crs(4326)

```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
data_path = here("data")
# Check what files we have
#list.files(data_path)

# Allow 10 GiB of memory
rJava::.jinit()
rJava::.jcall("java.lang.System", "S", "getProperty", "java.version")
options(java.parameters = "-Xmx10G")

library(r5r)
library(accessibility)
library(sf)
library(data.table)
library(ggplot2)
library(interp)
library(h3jsr)
library(h3r)
library(dplyr)
library(osmextract)
library(stplanr)

r5r_core = setup_r5(data_path = data_path)

```

```{r}
#travel time matrix

# Set parameters
mode = c("WALK")
max_walk_time = 90 # minutes
max_trip_duration = 90 # minutes
departure_datetime = as.POSIXct("23-05-2024 8:30:00",
                                 format = "%d-%m-%Y %H:%M:%S", 
                                tz = "GMT")

#note the code below already requires the h3 core matrix to be set up

# Calculate the travel time matrix by Transit
ttm_btn_lsoa_to_School = travel_time_matrix(r5r_core = r5r_core,
                          origins = bh_sec_sch,
                          destinations = brighton_lsoa_points_r5,
                          mode = mode,
                          departure_datetime = departure_datetime,
                          max_walk_time = max_walk_time,
                          max_trip_duration = max_trip_duration)

#join codes back to the matrix and get it ready from plotting
ttm_btn_lsoa_to_School$orig_lsoa <- brighton_lsoa_centroids$lsoa21cd[match(ttm_btn_lsoa_to_School$to_id, brighton_lsoa_centroids$fid)]

ttm_btn_lsoa_to_School$dest_sch <- brighton_sec_schools_wgs84$establishment_name[match(ttm_btn_lsoa_to_School$from_id, brighton_sec_schools_wgs84$urn)]

ttm_btn_lsoa_to_School <- ttm_btn_lsoa_to_School %>%
  mutate(to_id = as.factor(to_id)) %>%
  unite(od_code, orig_lsoa, to_id, sep = "_", remove = FALSE)

simple_ttm <- ttm_btn_lsoa_to_School %>%
  select(orig_lsoa, to_id, travel_time_p50) %>% 
  rename(orig = orig_lsoa, dest = to_id, flow = travel_time_p50)

class(ttm_btn_lsoa_to_School)

simple_ttm <- na.omit(simple_ttm)

#brighton_lsoa_to_school_times <- od2line(flow = simple_ttm, zones = lsoa_btn_pw_centroids, destinations = bh_sec_sch_bng, zone_code = "orig", dest_code = "dest", zone_code_d = "id")

#brighton_lsoa_to_school_times <- od2line(flow = simple_ttm, zones = lsoa_btn_pw_centroids, destinations = bh_sec_sch_bng, zone_code = "orig", dest_code = "dest", zone_code_d = "id")

#brighton_lsoa_to_school_times <- od2line(flow = simple_ttm, zones = lsoa_btn_pw_centroids, destinations = brighton_sec_schools)

#write_csv(simple_ttm, here("data", "simple_ttm.csv"))
#st_write(brighton_sec_schools, here("data", "brighton_sec_schools.geojson"), append = TRUE)

```

Remember VAT on private schools - look at private school numbers in the city
